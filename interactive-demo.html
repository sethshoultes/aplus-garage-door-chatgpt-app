<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A Plus Garage Door - Live ChatGPT Demo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: system-ui, -apple-system, sans-serif; }
        .message { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .typing-indicator {
            display: inline-flex;
            gap: 4px;
        }
        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #6b7280;
            animation: typing 1.4s infinite;
        }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.7; }
            30% { transform: translateY(-10px); opacity: 1; }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- API Key Modal -->
    <div id="apiKeyModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
            <h2 class="text-2xl font-bold text-gray-900 mb-4">üîë OpenAI API Key</h2>
            <p class="text-gray-600 mb-4">Enter your OpenAI API key to start the interactive demo:</p>
            <input
                type="password"
                id="apiKeyInput"
                placeholder="sk-..."
                class="w-full px-4 py-2 border border-gray-300 rounded-lg mb-4 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            />
            <button
                onclick="saveApiKey()"
                class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-blue-700 transition"
            >
                Start Demo
            </button>
            <p class="text-xs text-gray-500 mt-4">
                Your API key is stored locally and never sent anywhere except OpenAI's servers.
            </p>
        </div>
    </div>

    <!-- Main Chat Interface -->
    <div class="max-w-4xl mx-auto h-screen flex flex-col">
        <!-- Header -->
        <header class="bg-white border-b border-gray-200 p-4">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-xl font-bold text-gray-900">A Plus Garage Door</h1>
                    <p class="text-sm text-gray-500">Live ChatGPT Demo</p>
                </div>
                <div class="flex items-center gap-4">
                    <span class="text-sm text-green-600 flex items-center gap-2">
                        <span class="w-2 h-2 bg-green-600 rounded-full"></span>
                        Connected
                    </span>
                    <button onclick="clearChat()" class="text-sm text-gray-600 hover:text-gray-900">
                        Clear Chat
                    </button>
                </div>
            </div>
        </header>

        <!-- Messages -->
        <div id="messages" class="flex-1 overflow-y-auto p-4 space-y-4">
            <!-- Welcome message -->
            <div class="message">
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <p class="text-sm text-blue-800">
                        <strong>üëã Welcome to the A Plus Garage Door ChatGPT Demo!</strong><br><br>
                        Try asking:<br>
                        ‚Ä¢ "Do you service Henderson?"<br>
                        ‚Ä¢ "My garage door won't close"<br>
                        ‚Ä¢ "What deals do you have?"<br>
                        ‚Ä¢ "I need emergency service in Salt Lake City"
                    </p>
                </div>
            </div>
        </div>

        <!-- Input -->
        <div class="bg-white border-t border-gray-200 p-4">
            <div class="flex gap-2">
                <input
                    type="text"
                    id="userInput"
                    placeholder="Ask about garage door service..."
                    class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    onkeypress="if(event.key === 'Enter') sendMessage()"
                />
                <button
                    onclick="sendMessage()"
                    class="bg-blue-600 text-white px-6 py-3 rounded-lg font-medium hover:bg-blue-700 transition disabled:opacity-50 disabled:cursor-not-allowed"
                    id="sendButton"
                >
                    Send
                </button>
            </div>
        </div>
    </div>

    <script>
        let apiKey = '';
        const SERVER_URL = 'http://localhost:3456';
        const conversationHistory = [];

        function saveApiKey() {
            apiKey = document.getElementById('apiKeyInput').value.trim();
            if (!apiKey.startsWith('sk-')) {
                alert('Please enter a valid OpenAI API key starting with "sk-"');
                return;
            }
            localStorage.setItem('openai_api_key', apiKey);
            document.getElementById('apiKeyModal').style.display = 'none';
        }

        // Check for existing API key
        window.onload = function() {
            const stored = localStorage.getItem('openai_api_key');
            if (stored) {
                apiKey = stored;
                document.getElementById('apiKeyModal').style.display = 'none';
            }
        };

        function addMessage(role, content, isWidget = false) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';

            if (role === 'user') {
                messageDiv.innerHTML = `
                    <div class="flex justify-end">
                        <div class="bg-blue-600 text-white rounded-lg px-4 py-2 max-w-2xl">
                            ${content}
                        </div>
                    </div>
                `;
            } else if (isWidget) {
                messageDiv.innerHTML = `
                    <div class="bg-white rounded-lg border border-gray-200 p-4 max-w-2xl">
                        ${content}
                    </div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="bg-gray-100 rounded-lg px-4 py-2 max-w-2xl">
                        ${content}
                    </div>
                `;
            }

            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function showTyping() {
            const messagesDiv = document.getElementById('messages');
            const typingDiv = document.createElement('div');
            typingDiv.id = 'typing';
            typingDiv.className = 'message';
            typingDiv.innerHTML = `
                <div class="bg-gray-100 rounded-lg px-4 py-3 inline-block">
                    <div class="typing-indicator">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
            `;
            messagesDiv.appendChild(typingDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function removeTyping() {
            const typing = document.getElementById('typing');
            if (typing) typing.remove();
        }

        async function sendMessage() {
            const input = document.getElementById('userInput');
            const message = input.value.trim();
            if (!message) return;

            // Disable input
            input.disabled = true;
            document.getElementById('sendButton').disabled = true;

            // Add user message
            addMessage('user', message);
            input.value = '';

            // Add to history
            conversationHistory.push({
                role: 'user',
                content: message
            });

            // Show typing
            showTyping();

            try {
                // Call OpenAI API with function calling
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-4-turbo-preview',
                        messages: [
                            {
                                role: 'system',
                                content: 'You are a helpful assistant for A Plus Garage Door, a garage door service company covering Nevada and Utah. Use the provided tools to help customers check service areas, diagnose issues, view promotions, and book service. Always be helpful and professional.'
                            },
                            ...conversationHistory
                        ],
                        tools: await getToolDefinitions(),
                        tool_choice: 'auto'
                    })
                });

                const data = await response.json();
                removeTyping();

                if (data.error) {
                    addMessage('assistant', '‚ùå Error: ' + data.error.message);
                    return;
                }

                const assistantMessage = data.choices[0].message;

                // Handle function calls
                if (assistantMessage.tool_calls) {
                    for (const toolCall of assistantMessage.tool_calls) {
                        const toolName = toolCall.function.name;
                        const toolArgs = JSON.parse(toolCall.function.arguments);

                        // Call our local server
                        const toolResponse = await fetch(`${SERVER_URL}/test-tool`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                tool: toolName,
                                params: toolArgs
                            })
                        });

                        const toolResult = await toolResponse.json();

                        // Display the widget
                        displayWidget(toolName, toolResult);
                    }
                }

                // Add assistant text response
                if (assistantMessage.content) {
                    addMessage('assistant', assistantMessage.content);
                    conversationHistory.push(assistantMessage);
                }

            } catch (error) {
                removeTyping();
                addMessage('assistant', '‚ùå Error: ' + error.message);
            } finally {
                // Re-enable input
                input.disabled = false;
                document.getElementById('sendButton').disabled = false;
                input.focus();
            }
        }

        async function getToolDefinitions() {
            return [
                {
                    type: 'function',
                    function: {
                        name: 'check_service_area',
                        description: 'Check if A Plus Garage Door services a specific location in Nevada or Utah',
                        parameters: {
                            type: 'object',
                            properties: {
                                location: {
                                    type: 'string',
                                    description: 'City name or zip code (e.g., Henderson, Salt Lake City, 89123)'
                                }
                            },
                            required: ['location']
                        }
                    }
                },
                {
                    type: 'function',
                    function: {
                        name: 'diagnose_issue',
                        description: 'Diagnose garage door problems from symptoms',
                        parameters: {
                            type: 'object',
                            properties: {
                                symptoms: {
                                    type: 'array',
                                    items: { type: 'string' },
                                    description: 'List of symptoms (e.g., ["won\'t close", "loud grinding"])'
                                }
                            },
                            required: ['symptoms']
                        }
                    }
                },
                {
                    type: 'function',
                    function: {
                        name: 'get_promotions',
                        description: 'Get current A Plus Garage Door deals and promotions',
                        parameters: {
                            type: 'object',
                            properties: {
                                service_type: {
                                    type: 'string',
                                    enum: ['repair', 'installation', 'maintenance', 'all'],
                                    description: 'Type of service'
                                }
                            }
                        }
                    }
                },
                {
                    type: 'function',
                    function: {
                        name: 'create_service_request',
                        description: 'Book a garage door service appointment',
                        parameters: {
                            type: 'object',
                            properties: {
                                service_type: {
                                    type: 'string',
                                    enum: ['emergency_repair', 'standard_repair', 'installation', 'maintenance']
                                },
                                issue_summary: { type: 'string' },
                                customer_name: { type: 'string' },
                                phone: { type: 'string' },
                                address: { type: 'string' }
                            },
                            required: ['service_type', 'issue_summary', 'customer_name', 'phone', 'address']
                        }
                    }
                }
            ];
        }

        function displayWidget(toolName, data) {
            let widgetHTML = '';

            if (toolName === 'check_service_area') {
                if (data.is_covered) {
                    widgetHTML = `
                        <div class="flex items-center gap-3 mb-3">
                            <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center">
                                <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                </svg>
                            </div>
                            <div>
                                <p class="font-semibold text-gray-900">‚úÖ We service ${data.service_area_name}!</p>
                                <p class="text-sm text-gray-600">${data.state} ‚Ä¢ 24/7 emergency service</p>
                            </div>
                        </div>
                        <div class="bg-gray-50 rounded p-3 mb-3">
                            <p class="text-sm text-gray-700">Call now: <strong>${data.phone}</strong></p>
                        </div>
                    `;
                } else {
                    widgetHTML = `
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-yellow-100 rounded-full flex items-center justify-center">‚ö†Ô∏è</div>
                            <div>
                                <p class="font-semibold">Outside service area</p>
                                <p class="text-sm text-gray-600">Nearest: ${data.nearest_coverage}</p>
                            </div>
                        </div>
                    `;
                }
            } else if (toolName === 'diagnose_issue') {
                const urgencyColors = {
                    emergency: 'bg-red-100 text-red-800',
                    soon: 'bg-yellow-100 text-yellow-800',
                    routine: 'bg-blue-100 text-blue-800'
                };
                widgetHTML = `
                    <div class="${urgencyColors[data.urgency]} rounded-lg p-3 mb-3">
                        <strong>${data.urgency === 'emergency' ? 'üö®' : '‚ö°'} ${data.urgency.toUpperCase()}</strong>
                    </div>
                    <h3 class="font-semibold mb-2">Likely Issues:</h3>
                    ${data.likely_issues.map(issue => `
                        <div class="bg-gray-50 rounded p-3 mb-2">
                            <p class="font-medium">${issue.name}</p>
                            <p class="text-sm text-gray-600">${issue.description}</p>
                        </div>
                    `).join('')}
                    <div class="bg-gray-100 rounded p-3 mt-3">
                        <p class="text-sm"><strong>Estimated:</strong> $${data.estimated_cost_range.min} - $${data.estimated_cost_range.max}</p>
                    </div>
                `;
            } else if (toolName === 'get_promotions') {
                widgetHTML = `
                    <h3 class="font-semibold mb-3">üè∑Ô∏è Current Promotions</h3>
                    ${data.promotions.map(promo => `
                        <div class="border border-gray-200 rounded p-3 mb-2">
                            <p class="font-medium">${promo.title}</p>
                            <p class="text-sm text-green-600">${promo.discount}</p>
                            <p class="text-xs text-gray-500">${promo.description}</p>
                        </div>
                    `).join('')}
                `;
            } else if (toolName === 'create_service_request') {
                widgetHTML = `
                    <div class="flex items-center gap-3 mb-3">
                        <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                            <svg class="w-7 h-7 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                        </div>
                        <div>
                            <p class="font-semibold text-lg">Appointment Confirmed!</p>
                            <p class="text-sm text-gray-600">Confirmation #${data.confirmation_number}</p>
                        </div>
                    </div>
                    <div class="bg-gray-50 rounded p-4 space-y-2">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Service:</span>
                            <span class="font-medium">${data.service_type}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Time:</span>
                            <span class="font-medium">${data.time_window}</span>
                        </div>
                        ${data.promotion_applied ? `
                            <div class="bg-green-50 border border-green-200 rounded p-2 mt-2">
                                <p class="text-sm text-green-800">üè∑Ô∏è ${data.promotion_applied.discount} applied!</p>
                            </div>
                        ` : ''}
                    </div>
                `;
            }

            addMessage('assistant', widgetHTML, true);
        }

        function clearChat() {
            if (confirm('Clear chat history?')) {
                document.getElementById('messages').innerHTML = `
                    <div class="message">
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <p class="text-sm text-blue-800">
                                <strong>üëã Welcome to the A Plus Garage Door ChatGPT Demo!</strong><br><br>
                                Try asking:<br>
                                ‚Ä¢ "Do you service Henderson?"<br>
                                ‚Ä¢ "My garage door won't close"<br>
                                ‚Ä¢ "What deals do you have?"<br>
                                ‚Ä¢ "I need emergency service in Salt Lake City"
                            </p>
                        </div>
                    </div>
                `;
                conversationHistory.length = 0;
            }
        }
    </script>
</body>
</html>
